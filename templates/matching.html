{% extends "base.html" %}

{% block title %}AI匹配 - Talent Match{% endblock %}

{% block content %}
<div class="mb-4">
    <h2><i class="bi bi-lightning me-2"></i>AI人岗匹配</h2>
    <p class="text-muted">通过AI算法智能匹配候选人与职位，提供详细的匹配分析报告</p>
</div>

<!-- 匹配操作区域 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-magic me-1"></i>开始匹配</h5>
            </div>
            <div class="card-body">
                <form id="matchingForm">
                    <div class="row">
                        <div class="col-md-5">
                            <label for="resumeSelect" class="form-label">选择简历</label>
                            <select class="form-select" id="resumeSelect" required>
                                <option value="">请选择简历</option>
                                {% for resume in resumes %}
                                <option value="{{ resume.id }}">{{ resume.name }} - {{ resume.skills[:30] }}{% if resume.skills|length > 30 %}...{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label for="jdSelect" class="form-label">选择职位</label>
                            <select class="form-select" id="jdSelect" required>
                                <option value="">请选择职位</option>
                                {% for jd in job_descriptions %}
                                <option value="{{ jd.id }}">{{ jd.title }} - {{ jd.company }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-primary w-100" onclick="startMatching()">
                                <i class="bi bi-lightning me-1"></i>开始匹配
                            </button>
                        </div>
                    </div>
                </form>
                
                {% if not resumes or not job_descriptions %}
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    {% if not resumes %}请先添加简历。{% endif %}
                    {% if not job_descriptions %}请先添加职位描述。{% endif %}
                    <a href="{{ url_for('resume_management') }}" class="alert-link">管理简历</a> | 
                    <a href="{{ url_for('jd_management') }}" class="alert-link">管理职位</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 匹配结果展示 -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-graph-up me-1"></i>匹配历史</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadMatches()">
                    <i class="bi bi-arrow-clockwise me-1"></i>刷新
                </button>
            </div>
            <div class="card-body" id="matchResults">
                {% if matches %}
                    {% for match in matches %}
                    <div class="match-item border-bottom py-3">
                        <div class="row">
                            <div class="col-md-3">
                                <h6 class="mb-1">{{ match.resume_name }}</h6>
                                <small class="text-muted">简历ID: {{ match.resume_id }}</small>
                            </div>
                            <div class="col-md-3">
                                <h6 class="mb-1">{{ match.jd_title }}</h6>
                                <small class="text-muted">{{ match.company }}</small>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="match-score">
                                    <span class="badge bg-{% if match.match_score >= 80 %}success{% elif match.match_score >= 70 %}warning{% else %}danger{% endif %} fs-6">
                                        {{ match.match_score }}%
                                    </span>
                                </div>
                                <small class="text-muted d-block">匹配度</small>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="badge {% if match.recommendation == '推荐' %}bg-success{% elif match.recommendation == '一般推荐' %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ match.recommendation }}
                                </span>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#detail-{{ match.id }}">
                                    <i class="bi bi-eye me-1"></i>查看详情
                                </button>
                            </div>
                        </div>
                        
                        <!-- 详细分析 -->
                        <div class="collapse mt-3" id="detail-{{ match.id }}">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-success"><i class="bi bi-check-circle me-1"></i>优势</h6>
                                            <ul class="list-unstyled">
                                                {% for strength in match.strengths %}
                                                <li><i class="bi bi-arrow-right text-success me-1"></i>{{ strength }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>改进建议</h6>
                                            <ul class="list-unstyled">
                                                {% for improvement in match.improvements %}
                                                <li><i class="bi bi-arrow-right text-warning me-1"></i>{{ improvement }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-search display-1 text-muted"></i>
                        <h4 class="mt-3 text-muted">暂无匹配记录</h4>
                        <p class="text-muted">选择简历和职位开始AI匹配分析</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 开始匹配
function startMatching() {
    const resumeId = parseInt(document.getElementById('resumeSelect').value);
    const jdId = parseInt(document.getElementById('jdSelect').value);
    
    if (!resumeId || !jdId) {
        alert('请选择简历和职位');
        return;
    }

    // 显示加载状态
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>匹配中...';
    btn.disabled = true;

    fetch('/api/match', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            resume_id: resumeId,
            jd_id: jdId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('匹配完成！匹配度：' + data.match.match_score + '%');
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('匹配失败：' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// 加载匹配历史
function loadMatches() {
    fetch('/api/matches')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // 这里可以动态更新匹配历史
            console.log('匹配历史已加载', data.matches);
            location.reload();
        }
    })
    .catch(error => {
        console.error('加载匹配历史失败：', error);
    });
}
</script>
{% endblock %} 