{% extends "base.html" %}

{% block title %}人岗撮合 - Talent Match{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Left Panel: History -->
        <div class="col-lg-4">
            <div class="card" style="height: 85vh;">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>撮合历史</h5>
                </div>
                <div id="facilitationHistoryList" class="list-group list-group-flush overflow-auto">
                    {% if facilitation_history %}
                        {% for item in facilitation_history %}
                        <a href="#" class="list-group-item list-group-item-action" onclick="fetchFacilitationResult({{ item.id }})">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ item.resume_name }} & {{ item.jd_title }}</h6>
                            </div>
                            <small class="text-muted">{{ item.created_at }}</small>
                        </a>
                        {% endfor %}
                    {% else %}
                        <div class="text-center p-5">
                            <p class="text-muted">暂无历史记录</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Panel: Action and Results -->
        <div class="col-lg-8">
            <!-- Profile Generation Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-magic me-2"></i>AI生成画像</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="resumeSelect" class="form-label"><strong>选择简历</strong></label>
                            <select id="resumeSelect" class="form-select">
                                <option selected disabled>-- 请选择一份简历 --</option>
                                {% for resume in resumes %}
                                    <option value="{{ resume.id }}">ID: {{ resume.id }} - {{ resume.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="jdSelect" class="form-label"><strong>选择职位</strong></label>
                            <select id="jdSelect" class="form-select">
                                <option selected disabled>-- 请选择一个职位 --</option>
                                {% for jd in job_descriptions %}
                                    <option value="{{ jd.id }}">ID: {{ jd.id }} - {{ jd.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="generateProfiles()">
                        <i class="bi bi-person-badge-fill me-1"></i>生成求职和招聘画像
                    </button>
                </div>
            </div>

            <!-- Profile Result Card -->
            <div id="profileResultContainer" class="card d-none">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">画像生成结果</h5>
                    <span id="generationTime" class="badge bg-info fs-6 rounded-pill"></span>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6><i class="bi bi-file-person me-2"></i>候选人: <span id="resultResumeName" class="fw-normal"></span></h6>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-briefcase me-2"></i>职位: <span id="resultJdTitle" class="fw-normal"></span></h6>
                        </div>
                    </div>
                    
                    <!-- 新增：画像展示区域 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-info-subtle text-info-emphasis">
                                    <strong><i class="bi bi-person-badge me-2"></i>候选人求职画像</strong>
                                </div>
                                <div class="card-body">
                                    <div id="candidateProfile">
                                        <h6 class="text-muted">求职动机</h6>
                                        <p id="candidateMotivation" class="small mb-3"></p>
                                        <h6 class="text-muted">求职偏好</h6>
                                        <div id="candidatePreferences" class="mb-3"></div>
                                        <h6 class="text-muted">个人特质</h6>
                                        <div id="candidateTraits" class="mb-3"></div>
                                        <h6 class="text-muted">职业阶段</h6>
                                        <p id="candidateStage" class="small mb-0"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-secondary-subtle text-secondary-emphasis">
                                    <strong><i class="bi bi-building me-2"></i>企业招聘画像</strong>
                                </div>
                                <div class="card-body">
                                    <div id="companyProfile">
                                        <h6 class="text-muted">理想候选人</h6>
                                        <p id="idealCandidate" class="small mb-3"></p>
                                        <h6 class="text-muted">看重特质</h6>
                                        <div id="valuedTraits" class="mb-3"></div>
                                        <h6 class="text-muted">企业文化</h6>
                                        <p id="companyCulture" class="small mb-3"></p>
                                        <h6 class="text-muted">招聘策略</h6>
                                        <p id="hiringStrategy" class="small mb-0"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div id="profilePlaceholder" class="text-center py-5">
                 <i class="bi bi-person-badge display-1 text-muted"></i>
                <h4 class="mt-3 text-muted">请选择简历和职位生成AI画像</h4>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toast Notification System - 与其他页面保持一致
function showToast(message, type = 'info', duration = 2000) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-white bg-${type} border-0 fade-in`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    let icon = '';
    if (type === 'success') icon = '<i class="bi bi-check-circle-fill me-2"></i>';
    if (type === 'danger') icon = '<i class="bi bi-x-octagon-fill me-2"></i>';
    if (type === 'warning') icon = '<i class="bi bi-exclamation-triangle-fill me-2"></i>';
    if (type === 'info') icon = '<i class="bi bi-info-circle-fill me-2"></i>';
    if (type === 'primary') icon = '<i class="bi bi-gear-wide-connected me-2"></i>';

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${icon}
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;

    container.appendChild(toast);

    const bootstrapToast = new bootstrap.Toast(toast, {
        autohide: false // We will handle hiding manually
    });
    bootstrapToast.show();

    if (duration > 0) {
      setTimeout(() => {
          toast.classList.remove('fade-in');
          toast.classList.add('fade-out');
          toast.addEventListener('animationend', () => {
              bootstrapToast.hide();
              toast.remove();
          }, { once: true });
      }, duration);
    }
    
    return bootstrapToast;
}

function generateProfiles() {
    const resumeId = document.getElementById('resumeSelect').value;
    const jdId = document.getElementById('jdSelect').value;
    
    console.log('Debug - resumeId:', resumeId, 'jdId:', jdId);

    if (!resumeId || !jdId || resumeId.includes('请选择') || jdId.includes('请选择')) {
        console.log('Debug - Validation failed');
        showToast('请同时选择简历和职位', 'warning');
        return;
    }

    console.log('Debug - Starting profile generation request');
    const generationToast = showToast('AI生成画像中，请稍候...', 'primary', 0);

    fetch('/api/generate_profiles', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ resume_id: parseInt(resumeId), jd_id: parseInt(jdId) })
    })
    .then(response => {
        console.log('Debug - Got response:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Debug - Response data:', data);
        generationToast.hide();
        if (data.status === 'success') {
            displayProfileResult(data.profiles);
        } else {
            showToast('画像生成失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.log('Debug - Error:', error);
        generationToast.hide();
        showToast('操作失败: ' + error, 'danger');
    });
}

function fetchFacilitationResult(facilitationId) {
    const loadingToast = showToast('正在加载历史记录...', 'info', 0);
    fetch(`/api/facilitate/${facilitationId}`)
    .then(response => response.json())
    .then(data => {
        loadingToast.hide();
        if (data.status === 'success') {
            displayFacilitationResult(data.facilitation);
        } else {
            showToast('加载失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        loadingToast.hide();
        showToast('操作失败: ' + error, 'danger');
    });
}

function displayProfileResult(result) {
    document.getElementById('profilePlaceholder').classList.add('d-none');
    document.getElementById('profileResultContainer').classList.remove('d-none');

    document.getElementById('generationTime').innerText = `生成时间: ${new Date().toLocaleTimeString()}`;
    document.getElementById('resultResumeName').innerText = result.resume_name;
    document.getElementById('resultJdTitle').innerText = `${result.jd_title} @ ${result.company}`;

    // 显示候选人画像
    if (result.candidate_profile) {
        const profile = result.candidate_profile;
        document.getElementById('candidateMotivation').innerText = profile.motivation_story || '暂无';
        document.getElementById('candidateStage').innerText = profile.career_stage || '暂无';
        
        // 显示求职偏好
        const preferencesDiv = document.getElementById('candidatePreferences');
        preferencesDiv.innerHTML = '';
        if (profile.job_preferences && profile.job_preferences.length > 0) {
            profile.job_preferences.forEach(pref => {
                const span = document.createElement('span');
                span.className = 'badge bg-primary me-1 mb-1';
                span.innerText = pref;
                preferencesDiv.appendChild(span);
            });
        } else {
            preferencesDiv.innerHTML = '<span class="text-muted">暂无</span>';
        }
        
        // 显示个人特质
        const traitsDiv = document.getElementById('candidateTraits');
        traitsDiv.innerHTML = '';
        if (profile.personal_traits && profile.personal_traits.length > 0) {
            profile.personal_traits.forEach(trait => {
                const span = document.createElement('span');
                span.className = 'badge bg-info me-1 mb-1';
                span.innerText = trait;
                traitsDiv.appendChild(span);
            });
        } else {
            traitsDiv.innerHTML = '<span class="text-muted">暂无</span>';
        }
    }

    // 显示企业画像
    if (result.company_profile) {
        const profile = result.company_profile;
        document.getElementById('idealCandidate').innerText = profile.ideal_candidate || '暂无';
        document.getElementById('companyCulture').innerText = profile.company_culture || '暂无';
        document.getElementById('hiringStrategy').innerText = profile.hiring_strategy || '暂无';
        
        // 显示看重特质
        const traitsDiv = document.getElementById('valuedTraits');
        traitsDiv.innerHTML = '';
        if (profile.valued_traits && profile.valued_traits.length > 0) {
            profile.valued_traits.forEach(trait => {
                const span = document.createElement('span');
                span.className = 'badge bg-secondary me-1 mb-1';
                span.innerText = trait;
                traitsDiv.appendChild(span);
            });
        } else {
            traitsDiv.innerHTML = '<span class="text-muted">暂无</span>';
        }
    }
}
</script>
{% endblock %} 